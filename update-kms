#! /usr/bin/php
<?php /* -*- mode:php -*- */

require_once ("/var/slimstk/slimstkcmd.php");
slimstk_cmd_init ();

$db_done = array ();
foreach ($slimstk['stacks'] as $stkname => $stkinfo) {
	$database = $stkinfo['database'];
	$region = $stkinfo['region'];

	$pname = sprintf ("%s/dbpass.%s.%s",
			  $slimstk['confdir'],
			  $slimstk['aws_acct_name'],
			  $database);
	$gpg_name = sprintf ("%s.gpg", $pname);
	$kms_name = sprintf ("%s.%s.kms", $pname, $region);

	if (isset ($db_done[$kms_name]))
		continue;
	$db_done[$kms_name] = 1;

	slimstk_make_kms_for_region ($gpg_name, $region);
}

$region_done = array ();
foreach ($slimstk['stacks'] as $stkname => $stkinfo) {
	$region = $stkinfo['region'];

	if (isset ($region_done[$region]))
		continue;
	$region_done[$region] = 1;

	foreach ($slimstk['files'] as $filename) {
		$fullname = sprintf ("%s/%s", $slimstk['confdir'], $filename);
		$gpg_name = sprintf ("%s.gpg", $fullname);
		if (! file_exists ($gpg_name))
			continue;
		$kms_name = sprintf ("%s.%s.kms", $fullname, $region);
		slimstk_make_kms_for_region ($gpg_name, $region);
	}
}
