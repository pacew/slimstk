#! /usr/bin/php
<?php /* -*- mode:php -*- */

require_once ("./slimstk.php");
slimstk_cmd_init ();

$db_done = array ();
foreach ($slimstk['stacks'] as $stkname => $stkinfo) {
	$database = $stkinfo['database'];
	$region = $stkinfo['region'];

	$pname = sprintf ("%s/dbpass.%s.%s",
			  $slimstk['confdir'],
			  $slimstk['aws_acct_name'],
			  $database);
	$gpg_name = sprintf ("%s.gpg", $pname);
	$kms_name = sprintf ("%s.%s.kms", $pname, $region);

	if (isset ($db_done[$kms_name]))
		continue;
	$db_done[$kms_name] = 1;

	slimstk_make_kms_for_region ($gpg_name, $region);
}

$key_done = array ();
foreach ($slimstk['stacks'] as $stkname => $stkinfo) {
	$region = $stkinfo['region'];

	foreach ($stkinfo['sites'] as $siteid => $sinfo) {
		$app_name = preg_replace ('/-.*/', '', $siteid);

		$basename = sprintf ("%s/deploy-%s",
				     $slimstk['confdir'], $app_name);
		$gpg_name = sprintf ("%s.gpg", $basename);
		$kms_name = sprintf ("%s.%s.kms", $basename, $region);

		if (isset ($key_done[$kms_name]))
			continue;
		$key_done[$kms_name] = 1;

		slimstk_make_kms_for_region ($gpg_name, $region);
	}
}
	